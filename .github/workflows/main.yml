name: Enviar mÃ©tricas de PR com IA

on:
  pull_request:
    types: [opened, reopened, synchronize, closed, labeled, unlabeled]

jobs:
  enviar-metricas:
    runs-on: ubuntu-latest

    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
      # 1. Extrair dados do PR + formulÃ¡rio            #
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
      - name: Extrair informaÃ§Ãµes do PR
        id: extrair
        shell: bash
        run: |
          set -Eeuo pipefail
          echo '::group::Extraindo informaÃ§Ãµes do PR'

          pr_number="${{ github.event.pull_request.number }}"
          pr_title="${{ github.event.pull_request.title }}"
          pr_body="${{ github.event.pull_request.body || '' }}"
          pr_status="${{ github.event.pull_request.state }}"
          created_at="${{ github.event.pull_request.created_at }}"
          merged_at="${{ github.event.pull_request.merged_at }}"
          repository="${{ github.repository }}"
          developer_name="${{ github.actor }}"
          developer_email="unknown@example.com"

          # 1) Ferramenta de IA â”€ default: not_informed
          shopt -s nocasematch
          if echo "$pr_body" | grep -iqP '\-\s*\[x\]\s*Copilot';      then ia_tool_used="Copilot"
          elif echo "$pr_body" | grep -iqP '\-\s*\[x\]\s*Cursor';     then ia_tool_used="Cursor"
          elif echo "$pr_body" | grep -iqP '\-\s*\[x\]\s*Devin';      then ia_tool_used="Devin"
          elif echo "$pr_body" | grep -iqP '\-\s*\[x\]\s*Nenhuma';    then ia_tool_used="Nenhuma"
          elif echo "$pr_body" | grep -iqP '\-\s*\[x\]\s*Outra';      then
               ia_tool_used=$(echo "$pr_body" | grep -iP '\-\s*\[x\]\s*Outra' | sed -E 's/.*Outra[^:]*:\s*//I')
               [[ -z "$ia_tool_used" ]] && ia_tool_used="Outra"
          else
               ia_tool_used="not_informed"
          fi
          shopt -u nocasematch

          # 2) CenÃ¡rios (podem ser vÃ¡rios) â”€ default: none
          declare -A map=(
            ["GeraÃ§Ã£o de cÃ³digo boilerplate"]="boilerplate"
            ["ExplicaÃ§Ã£o de trechos de cÃ³digo"]="explain_code"
            ["SugestÃµes de melhorias/refatoraÃ§Ã£o"]="refactor_suggestions"
          )
          scenarios=()
          for pretty in "${!map[@]}"; do
            if echo "$pr_body" | grep -iqP "\-\s*\[x\]\s*${pretty}"; then
              scenarios+=("${map[$pretty]}")
            fi
          done
          ia_usage_scenarios=$(IFS=','; echo "${scenarios[*]:-none}")
          [[ -z "$ia_usage_scenarios" ]] && ia_usage_scenarios="none"

          # 3) Nota de produtividade 0-10 â”€ default: null
          productivity_score=$(echo "$pr_body" | grep -oP '(?i)Produtividade *\(0-10\).*?([0-9]{1,2})' | tail -1 | grep -oP '[0-9]{1,2}' || true)
          if [[ -z "${productivity_score:-}" || $productivity_score -gt 10 ]]; then
            productivity_score="null"
          fi

          # 4) Justificativa â”€ default: ""
          productivity_reason=$(echo "$pr_body" | awk '
              BEGIN{flag=0}
              /###[[:space:]]*ðŸ’¬/{flag=1;next}
              /^---/{flag=0}
              flag {gsub(/^[> ]+/,""); printf "%s\\n",$0}
          ' | sed ':a;N;$!ba;s/\n/ /g' | sed 's/  */ /g' | sed 's/\"/\\"/g')
          [[ -z "$productivity_reason" ]] && productivity_reason=""

          # 5) Linhas adicionadas/removidas (defaults 0)
          pr_files_url="https://api.github.com/repos/${repository}/pulls/${pr_number}/files"
          pr_files_json=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$pr_files_url")
          added_lines=$(echo "$pr_files_json" | jq '[.[] | .additions] | add // 0')
          removed_lines=$(echo "$pr_files_json" | jq '[.[] | .deletions] | add // 0')

          # 6) Data do primeiro commit
          pr_commits_url="https://api.github.com/repos/${repository}/pulls/${pr_number}/commits"
          first_commit_date=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$pr_commits_url" | jq -r '.[0].commit.committer.date // empty')

          # 7) Sanitizar corpo do PR para JSON
          printf '%s' "$pr_body" | jq -Rs '.' > body.txt

          # 8) JSON-safe nulos
          merged_at_json="${merged_at:-null}"
          [[ "$merged_at_json" != "null" && -n "$merged_at_json" ]] && merged_at_json="\"$merged_at_json\""
          first_commit_date_json="${first_commit_date:-null}"
          [[ "$first_commit_date_json" != "null" && -n "$first_commit_date_json" ]] && first_commit_date_json="\"$first_commit_date_json\""

          # 9) Exportar variÃ¡veis
          {
            echo "pr_number=$pr_number"
            echo "pr_title=$pr_title"
            echo "pr_status=$pr_status"
            echo "developer_name=$developer_name"
            echo "developer_email=$developer_email"
            echo "created_at=$created_at"
            echo "merged_at_json=$merged_at_json"
            echo "ia_tool_used=$ia_tool_used"
            echo "ia_usage_scenarios=$ia_usage_scenarios"
            echo "productivity_score=$productivity_score"
            echo "productivity_reason=$productivity_reason"
            echo "added_lines=$added_lines"
            echo "removed_lines=$removed_lines"
            echo "repository=$repository"
            echo "first_commit_date_json=$first_commit_date_json"
          } >> "$GITHUB_ENV"

          echo '::endgroup::'

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
      # 2. Enviar payload ao Supabase                  #
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #
      - name: Enviar dados ao Supabase
        run: |
          set -Eeuo pipefail
          echo '::group::Enviando dados ao Supabase'

          jq -n \
            --arg pr_number "$pr_number" \
            --arg pr_title "$pr_title" \
            --slurpfile pr_body body.txt \
            --arg pr_status "$pr_status" \
            --arg developer_name "$developer_name" \
            --arg developer_email "$developer_email" \
            --arg created_at "$created_at" \
            --arg ia_tool_used "$ia_tool_used" \
            --arg ia_usage_scenarios "$ia_usage_scenarios" \
            --arg productivity_score "$productivity_score" \
            --arg productivity_reason "$productivity_reason" \
            --arg added_lines "$added_lines" \
            --arg removed_lines "$removed_lines" \
            --arg repository "$repository" \
            --arg merged_at_raw "$merged_at_json" \
            --arg first_commit_date_raw "$first_commit_date_json" \
            '{
              pr_number: ($pr_number | tonumber),
              pr_title: $pr_title,
              pr_body: $pr_body[0],
              pr_status: $pr_status,
              developer_name: $developer_name,
              developer_email: $developer_email,
              created_at: $created_at,
              merged_at: ($merged_at_raw | fromjson),
              ia_tool_used: $ia_tool_used,
              ia_usage_scenarios: $ia_usage_scenarios,
              productivity_score: ($productivity_score | tonumber?),
              productivity_reason: $productivity_reason,
              added_lines: ($added_lines | tonumber),
              removed_lines: ($removed_lines | tonumber),
              repository: $repository,
              first_commit_date: ($first_commit_date_raw | fromjson)
            }' > payload.json

          cat payload.json

          curl -X POST \
            "$SUPABASE_URL/rest/v1/pr_metrics_v2?on_conflict=repository,pr_number" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation,resolution=merge-duplicates" \
            -d @payload.json

          echo '::endgroup::'
