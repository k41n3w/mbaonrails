name: PR AI Usage Metrics

on:
  pull_request:
    types: [closed, labeled]

jobs:
  send_metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Extract PR Info and Labels
        id: pr_info
        run: |
          echo '::group::Coletando informações do PR'

          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_STATUS="${{ github.event.pull_request.state }}"
          DEV_NAME="${{ github.event.pull_request.user.login }}"
          CREATED_AT="${{ github.event.pull_request.created_at }}"
          MERGED_AT="${{ github.event.pull_request.merged_at }}"
          REPO_NAME="${{ github.repository }}"

          # Fallback para email
          DEV_EMAIL="unknown@example.com"

          LABELS_JSON='${{ toJson(github.event.pull_request.labels) }}'
          AI_TOOLS=$(echo "$LABELS_JSON" | jq -r '[.[] | select(.name=="Copilot" or .name=="Cursor" or .name=="Devin" or .name=="Não usei IA") | .name]')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          echo "pr_status=$PR_STATUS" >> $GITHUB_OUTPUT
          echo "developer_name=$DEV_NAME" >> $GITHUB_OUTPUT
          echo "developer_email=$DEV_EMAIL" >> $GITHUB_OUTPUT
          echo "created_at=$CREATED_AT" >> $GITHUB_OUTPUT
          echo "merged_at=$MERGED_AT" >> $GITHUB_OUTPUT
          echo "ai_tools=$AI_TOOLS" >> $GITHUB_OUTPUT
          echo "repository=$REPO_NAME" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Send Data to Supabase
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo '::group::Enviando dados ao Supabase'
          curl -X POST \
            "${SUPABASE_URL}/rest/v1/pr_metrics" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d @- <<EOF
{
  "pr_number": ${{ steps.pr_info.outputs.pr_number }},
  "pr_title": "${{ steps.pr_info.outputs.pr_title }}",
  "pr_status": "${{ steps.pr_info.outputs.pr_status }}",
  "developer_name": "${{ steps.pr_info.outputs.developer_name }}",
  "developer_email": "${{ steps.pr_info.outputs.developer_email }}",
  "created_at": "${{ steps.pr_info.outputs.created_at }}",
  "merged_at": ${{ steps.pr_info.outputs.merged_at && format('"{0}"', steps.pr_info.outputs.merged_at) || "null" }},
  "ai_tools": ${{ steps.pr_info.outputs.ai_tools }},
  "repository": "${{ steps.pr_info.outputs.repository }}"
}
EOF
          echo "::endgroup::"
