name: PR AI Usage Metrics

on:
  pull_request:
    types: [opened, reopened, synchronize, closed, labeled, unlabeled]

jobs:
  send_metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Extraindo informações do PR
        id: pr_info
        run: |
          echo '::group::Extraindo informações do PR'

          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_STATUS="${{ github.event.pull_request.state }}"
          DEV_NAME="${{ github.event.pull_request.user.login }}"
          CREATED_AT="${{ github.event.pull_request.created_at }}"
          MERGED_AT="${{ github.event.pull_request.merged_at }}"
          REPO_NAME="${{ github.repository }}"
          DEV_EMAIL="unknown@example.com"

          # IA - placeholders fixos (pode evoluir depois)
          TIME_SAVED_PERCENTAGE="20%"
          TIME_SAVED_REASON="Usando o Copilot, consegui acelerar a escrita do código."
          IA_USAGE_MODE="Autocomplete"
          IA_USAGE_FREQUENCY="Cerca de metade do tempo"
          IA_USAGE_INVESTMENT="Resolver vulnerabilidades"

          # Detecta IA usada a partir do pr_body
          if echo "$PR_BODY" | grep -q '\- \[x\] Copilot'; then
            IA_TOOL_USED="Copilot"
          elif echo "$PR_BODY" | grep -q '\- \[x\] Cursor'; then
            IA_TOOL_USED="Cursor"
          elif echo "$PR_BODY" | grep -q '\- \[x\] Devin'; then
            IA_TOOL_USED="Devin"
          elif echo "$PR_BODY" | grep -q '\- \[x\] Nenhuma'; then
            IA_TOOL_USED="Nenhuma"
          elif echo "$PR_BODY" | grep -q '\- \[x\] Outra'; then
            IA_TOOL_USED=$(echo "$PR_BODY" | grep '\- \[x\] Outra' | sed -E 's/.*Outra \(qual\)?:\s*//')
          else
            IA_TOOL_USED="not_informed"
          fi

          # merged_at
          if [[ -z "$MERGED_AT" || "$MERGED_AT" == "null" ]]; then
            MERGED_AT_JSON=null
          else
            MERGED_AT_JSON="\"$MERGED_AT\""
          fi

          # Linhas adicionadas/removidas
          PR_FILES_URL="https://api.github.com/repos/${REPO_NAME}/pulls/${PR_NUMBER}/files"
          PR_FILES_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$PR_FILES_URL")
          ADDED_LINES=$(echo "$PR_FILES_JSON" | jq '[.[] | .additions] | add // 0')
          REMOVED_LINES=$(echo "$PR_FILES_JSON" | jq '[.[] | .deletions] | add // 0')

          # Primeiro commit
          PR_COMMITS_URL="https://api.github.com/repos/${REPO_NAME}/pulls/${PR_NUMBER}/commits"
          FIRST_COMMIT_DATE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$PR_COMMITS_URL" | jq -r '.[0].commit.committer.date')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr_title=$PR_TITLE" >> $GITHUB_OUTPUT
          {
            echo "pr_body<<EOF"
            echo "$PR_BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "pr_status=$PR_STATUS" >> $GITHUB_OUTPUT
          echo "developer_name=$DEV_NAME" >> $GITHUB_OUTPUT
          echo "developer_email=$DEV_EMAIL" >> $GITHUB_OUTPUT
          echo "created_at=$CREATED_AT" >> $GITHUB_OUTPUT
          echo "merged_at=$MERGED_AT_JSON" >> $GITHUB_OUTPUT
          echo "ia_tool_used=$IA_TOOL_USED" >> $GITHUB_OUTPUT
          echo "time_saved_percentage=$TIME_SAVED_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "time_saved_reason=$TIME_SAVED_REASON" >> $GITHUB_OUTPUT
          echo "ia_usage_mode=$IA_USAGE_MODE" >> $GITHUB_OUTPUT
          echo "ia_usage_frequency=$IA_USAGE_FREQUENCY" >> $GITHUB_OUTPUT
          echo "ia_usage_investment=$IA_USAGE_INVESTMENT" >> $GITHUB_OUTPUT
          echo "added_lines=$ADDED_LINES" >> $GITHUB_OUTPUT
          echo "removed_lines=$REMOVED_LINES" >> $GITHUB_OUTPUT
          echo "repository=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "first_commit_date=${FIRST_COMMIT_DATE:-null}" >> $GITHUB_OUTPUT

          echo '::endgroup::'

      - name: Enviando dados ao Supabase
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo '::group::Enviando dados ao Supabase'

          jq -n \
            --arg pr_number "${{ steps.pr_info.outputs.pr_number }}" \
            --arg pr_title "${{ steps.pr_info.outputs.pr_title }}" \
            --arg pr_body "${{ steps.pr_info.outputs.pr_body }}" \
            --arg pr_status "${{ steps.pr_info.outputs.pr_status }}" \
            --arg developer_name "${{ steps.pr_info.outputs.developer_name }}" \
            --arg developer_email "${{ steps.pr_info.outputs.developer_email }}" \
            --arg created_at "${{ steps.pr_info.outputs.created_at }}" \
            --argjson merged_at "${{ steps.pr_info.outputs.merged_at }}" \
            --arg ia_tool_used "${{ steps.pr_info.outputs.ia_tool_used }}" \
            --arg time_saved_percentage "${{ steps.pr_info.outputs.time_saved_percentage }}" \
            --arg time_saved_reason "${{ steps.pr_info.outputs.time_saved_reason }}" \
            --arg ia_usage_mode "${{ steps.pr_info.outputs.ia_usage_mode }}" \
            --arg ia_usage_frequency "${{ steps.pr_info.outputs.ia_usage_frequency }}" \
            --arg ia_usage_investment "${{ steps.pr_info.outputs.ia_usage_investment }}" \
            --argjson added_lines "${{ steps.pr_info.outputs.added_lines }}" \
            --argjson removed_lines "${{ steps.pr_info.outputs.removed_lines }}" \
            --arg repository "${{ steps.pr_info.outputs.repository }}" \
            --arg first_commit_date "${{ steps.pr_info.outputs.first_commit_date }}" \
            '{
              pr_number: ($pr_number | tonumber),
              pr_title: $pr_title,
              pr_body: $pr_body,
              pr_status: $pr_status,
              developer_name: $developer_name,
              developer_email: $developer_email,
              created_at: $created_at,
              merged_at: $merged_at,
              ia_tool_used: $ia_tool_used,
              time_saved_percentage: $time_saved_percentage,
              time_saved_reason: $time_saved_reason,
              ia_usage_mode: $ia_usage_mode,
              ia_usage_frequency: $ia_usage_frequency,
              ia_usage_investment: $ia_usage_investment,
              added_lines: $added_lines,
              removed_lines: $removed_lines,
              repository: $repository,
              first_commit_date: ($first_commit_date == "null" or $first_commit_date == "" ? null : $first_commit_date)
            }' > payload.json

          cat payload.json

          curl -X POST \
            "$SUPABASE_URL/rest/v1/pr_metrics_v2?on_conflict=repository,pr_number" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation,resolution=merge-duplicates" \
            -d @payload.json

          echo '::endgroup::'
